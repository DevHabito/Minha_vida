<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Vida em Semanas | Memento Mori</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b', 
                            950: '#020617',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Remove default arrow/spin buttons from number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .week-box {
            aspect-ratio: 1;
            transition: all 0.2s ease;
            border-radius: 2px;
        }
        .week-box:hover {
            transform: scale(2.5);
            z-index: 40;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        
        /* Pulse animation for current week */
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 4px rgba(234, 179, 8, 0); transform: scale(1.2); }
        }
        
        .current-week {
            animation: pulse-gold 2s infinite;
            z-index: 10;
        }

        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Glass effect for the timer */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(30, 41, 59, 0.5);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-500 selection:bg-indigo-500 selection:text-white">

    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-200/60 dark:border-slate-800/60 transition-colors duration-500">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-indigo-500/20">
                    M
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Memento Mori</h1>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-widest font-semibold">Sua Vida em Semanas</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="p-2 rounded-full text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" title="Alternar Tema">
                    <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>

                <button onclick="resetData()" class="text-xs font-medium text-slate-400 hover:text-rose-500 dark:hover:text-rose-400 transition-colors px-3 py-1.5 rounded-full hover:bg-rose-50 dark:hover:bg-rose-900/20" title="Limpar dados">
                    Reiniciar
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center justify-start py-8 px-4 sm:px-6 relative overflow-hidden">
        
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[800px] bg-indigo-100/40 dark:bg-indigo-900/10 rounded-full blur-3xl -z-10 pointer-events-none transition-colors duration-500"></div>

        <div id="setup-panel" class="w-full max-w-md bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm p-8 rounded-2xl shadow-xl shadow-indigo-100/50 dark:shadow-black/50 border border-white dark:border-slate-800 mb-8 hidden fade-in mt-10 transition-colors duration-500">
            <h2 class="text-2xl font-bold mb-3 text-center">Inicie sua Jornada</h2>
            <p class="text-slate-500 dark:text-slate-400 text-sm text-center mb-8 leading-relaxed">
                "A vida é longa o bastante se soubermos usá-la."<br>
                Configure sua jornada pessoal.
            </p>
            
            <div class="flex flex-col gap-6">
                <div class="relative">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 ml-1">Data de Nascimento</label>
                    <input type="date" id="birthdate-input" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none font-medium transition-all hover:bg-white dark:hover:bg-slate-750 dark:text-white dark:calendar-invert">
                </div>
                
                <div class="relative">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 ml-1">Expectativa de Vida (Anos)</label>
                    
                    <!-- New Stepper Control -->
                    <div class="flex items-center h-14 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-transparent transition-all hover:bg-white dark:hover:bg-slate-750">
                        <button type="button" onclick="adjustExpectancy(-1)" class="w-14 h-full flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors active:scale-95">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        
                        <input type="number" id="expectancy-input" value="80" min="1" max="120" class="flex-1 h-full text-center bg-transparent border-none focus:ring-0 outline-none font-bold text-lg text-slate-700 dark:text-slate-200" placeholder="80">
                        
                        <button type="button" onclick="adjustExpectancy(1)" class="w-14 h-full flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors active:scale-95">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>

                <button onclick="generateChart()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] transition-all active:scale-[0.98] mt-2">
                    Visualizar Minha Vida
                </button>
            </div>
        </div>

        <div id="live-timer-panel" class="hidden w-full max-w-6xl mb-6 fade-in relative">
            <div class="glass-panel p-6 sm:p-8 rounded-3xl shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-indigo-500 via-purple-500 to-pink-500"></div>
                
                <!-- Toggle Button (Responsivo: Flex no mobile, Absolute no desktop) -->
                <div class="flex justify-center w-full mb-3 sm:absolute sm:top-4 sm:right-4 sm:w-auto sm:mb-0 z-20">
                    <button onclick="toggleTimerMode()" class="text-[10px] uppercase tracking-wider font-bold text-indigo-500 hover:text-indigo-600 bg-white/50 hover:bg-white/80 dark:bg-slate-800/50 dark:hover:bg-slate-800/80 backdrop-blur px-3 py-1.5 rounded-full transition-all border border-transparent hover:border-indigo-100 dark:hover:border-slate-700 shadow-sm" id="timer-toggle-btn">
                        Ver Tempo Restante
                    </button>
                </div>

                <h3 id="timer-title" class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-[0.2em] mb-4 text-center transition-all">Sua Idade Cronológica</h3>
                
                <!-- Updated Timer Layout: flex-nowrap + responsive adjustments -->
                <div class="flex flex-nowrap justify-center items-center gap-1.5 sm:gap-8 md:gap-12 select-none">
                    
                    <!-- Anos -->
                    <div class="flex flex-col items-center">
                        <span id="timer-years" class="font-mono text-2xl sm:text-5xl font-bold text-slate-800 dark:text-slate-200 tracking-tight tabular-nums">00</span>
                        <span class="text-[9px] sm:text-xs text-slate-400 uppercase tracking-widest mt-1">Anos</span>
                    </div>

                    <div class="h-8 w-px bg-slate-200 dark:bg-slate-700 hidden sm:block"></div>

                    <!-- Dias -->
                    <div class="flex flex-col items-center">
                        <span id="timer-days" class="font-mono text-2xl sm:text-5xl font-bold text-slate-800 dark:text-slate-200 tracking-tight tabular-nums">000</span>
                        <span class="text-[9px] sm:text-xs text-slate-400 uppercase tracking-widest mt-1">Dias</span>
                    </div>

                    <div class="h-8 w-px bg-slate-200 dark:bg-slate-700 hidden sm:block"></div>

                    <!-- Horas -->
                    <div class="flex flex-col items-center">
                        <span id="timer-hours" class="font-mono text-2xl sm:text-5xl font-bold text-indigo-600 dark:text-indigo-400 tracking-tight tabular-nums">00</span>
                        <span class="text-[9px] sm:text-xs text-indigo-500/70 uppercase tracking-widest mt-1">Horas</span>
                    </div>

                    <span class="text-xl sm:text-4xl font-light text-slate-300 dark:text-slate-700 animate-pulse">:</span>

                    <!-- Minutos -->
                    <div class="flex flex-col items-center">
                        <span id="timer-minutes" class="font-mono text-2xl sm:text-5xl font-bold text-indigo-600 dark:text-indigo-400 tracking-tight tabular-nums">00</span>
                        <span class="text-[9px] sm:text-xs text-indigo-500/70 uppercase tracking-widest mt-1">Min</span>
                    </div>

                    <span class="text-xl sm:text-4xl font-light text-slate-300 dark:text-slate-700 animate-pulse">:</span>

                    <!-- Segundos -->
                    <div class="flex flex-col items-center relative">
                        <span id="timer-seconds" class="font-mono text-2xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-indigo-500 to-purple-600 tracking-tight tabular-nums min-w-[1.5em] text-center">00</span>
                        <span class="text-[9px] sm:text-xs text-purple-500/70 uppercase tracking-widest mt-1">Seg</span>
                        
                        <!-- Glow effect behind seconds -->
                        <div class="absolute inset-0 bg-indigo-500/20 blur-xl rounded-full -z-10 animate-pulse-slow"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="stats-panel" class="w-full max-w-6xl mb-10 hidden fade-in">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center hover:shadow-md transition-all relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-indigo-500"></div>
                    <span class="block text-3xl sm:text-4xl font-extrabold mb-1 tracking-tight" id="weeks-lived">0</span>
                    <span class="text-[10px] sm:text-xs font-bold text-indigo-500 uppercase tracking-widest">Semanas Vividas</span>
                </div>
                
                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center hover:shadow-md transition-all relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 to-teal-500"></div>
                    <span class="block text-3xl sm:text-4xl font-extrabold text-slate-800 dark:text-slate-100 mb-1 tracking-tight" id="months-lived">0</span>
                    <span class="text-[10px] sm:text-xs font-bold text-teal-500 uppercase tracking-widest">Meses Vividos</span>
                </div>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center hover:shadow-md transition-all relative overflow-hidden">
                     <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                    <span class="block text-3xl sm:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 mb-1 tracking-tight" id="percentage-lived">0%</span>
                    <span class="text-[10px] sm:text-xs font-bold text-purple-500 uppercase tracking-widest" id="life-total-label">Vida (90 Anos)</span>
                </div>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center hover:shadow-md transition-all relative overflow-hidden">
                     <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-400 to-pink-500"></div>
                    <span class="block text-3xl sm:text-4xl font-extrabold text-slate-400 dark:text-slate-500 mb-1 tracking-tight" id="weeks-left">0</span>
                    <span class="text-[10px] sm:text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Semanas Restantes</span>
                </div>
            </div>

            <div class="flex flex-wrap justify-center items-center gap-4 md:gap-8 text-sm text-slate-600 dark:text-slate-400 mb-2">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-sm bg-gradient-to-br from-indigo-500 to-purple-600"></div>
                    <span>Passado</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-sm bg-gradient-to-br from-pink-500 to-rose-600 shadow-[0_0_5px_rgba(244,63,94,0.4)]"></div>
                    <span>Aniversário</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-sm bg-amber-400 shadow-[0_0_8px_rgba(251,191,36,0.5)]"></div>
                    <span class="font-bold text-amber-600 dark:text-amber-400">Esta Semana</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-sm bg-slate-200 dark:bg-slate-800"></div>
                    <span>Futuro</span>
                </div>
            </div>
        </div>

        <div id="life-grid-container" class="hidden w-full max-w-[1200px] flex justify-center">
            <!-- Grid container with responsive classes built-in -->
            <div id="life-grid" class="fade-in grid gap-[2px] sm:gap-[3px] mx-auto p-3 sm:p-6 bg-white dark:bg-slate-900 rounded-xl sm:rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-black/50 border border-slate-100 dark:border-slate-800 transition-colors duration-500 grid-cols-[repeat(26,minmax(0,1fr))] sm:grid-cols-[repeat(52,minmax(0,1fr))]">
            </div>
        </div>

        <div id="quote-panel" class="my-16 max-w-2xl text-center hidden fade-in px-4">
            <div class="w-16 h-1 bg-gradient-to-r from-transparent via-indigo-300 dark:via-indigo-700 to-transparent mx-auto mb-6"></div>
            <blockquote class="text-xl md:text-2xl text-slate-700 dark:text-slate-300 font-medium leading-relaxed">
                "Não é que tenhamos pouco tempo,<br> <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">mas desperdiçamos muito dele.</span>"
            </blockquote>
            <cite class="block mt-4 text-sm font-bold text-slate-400 dark:text-slate-500 not-italic uppercase tracking-widest">— Sêneca</cite>
        </div>

    </main>

    <footer class="bg-white dark:bg-slate-900 py-8 border-t border-slate-100 dark:border-slate-800 mt-auto transition-colors duration-500">
        <div class="flex flex-col items-center justify-center gap-2 px-4">
            <p class="text-center text-slate-400 dark:text-slate-500 text-xs font-medium">
                Cada quadrado é uma semana. Cada linha é um ano (aproximadamente).<br>
                Memento Mori.
            </p>
            <p class="text-center text-slate-400 dark:text-slate-500 text-xs mt-4 opacity-75">
                Site criado por Felipe Gianini Romero
            </p>
        </div>
    </footer>

    <div id="reset-modal" class="relative z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity fade-in"></div>

        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-slate-900 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-slate-100 dark:border-slate-800 ring-1 ring-slate-900/5 fade-in">
                    
                    <div class="bg-white dark:bg-slate-900 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-rose-100 dark:bg-rose-900/30 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-rose-600 dark:text-rose-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                                <h3 class="text-lg font-semibold leading-6 text-slate-900 dark:text-white" id="modal-title">Redefinir Jornada?</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-slate-500 dark:text-slate-400">
                                        Isso apagará seus dados atuais e recarregará a página para que você possa iniciar uma nova contagem.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 dark:bg-slate-950/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-3">
                        <button type="button" onclick="confirmResetAction()" class="inline-flex w-full justify-center rounded-xl bg-rose-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-rose-50 sm:w-auto transition-colors">
                            Sim, reiniciar
                        </button>
                        <button type="button" onclick="closeModal()" class="mt-3 inline-flex w-full justify-center rounded-xl bg-white dark:bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-900 dark:text-slate-300 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 sm:mt-0 sm:w-auto transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEEKS_PER_YEAR = 52;
        let timerInterval;
        let timerMode = 'elapsed'; // 'elapsed' or 'remaining'
        let currentBirthDate = null;
        let currentExpectancy = null;

        // Theme Handling
        function toggleTheme() {
            const html = document.documentElement;
            const sun = document.getElementById('sun-icon');
            const moon = document.getElementById('moon-icon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                sun.classList.add('hidden');
                moon.classList.remove('hidden');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                moon.classList.add('hidden');
                sun.classList.remove('hidden');
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const html = document.documentElement;
            const sun = document.getElementById('sun-icon');
            const moon = document.getElementById('moon-icon');

            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
                moon.classList.add('hidden');
                sun.classList.remove('hidden');
            } else {
                html.classList.remove('dark');
                sun.classList.add('hidden');
                moon.classList.remove('hidden');
            }
        }

        // Stepper Function for Life Expectancy
        function adjustExpectancy(change) {
            const input = document.getElementById('expectancy-input');
            let currentValue = parseInt(input.value) || 80;
            let newValue = currentValue + change;
            
            // Validate limits
            if (newValue < 1) newValue = 1;
            if (newValue > 120) newValue = 120;
            
            input.value = newValue;
        }

        // Timer Toggle Function
        function toggleTimerMode() {
            const btn = document.getElementById('timer-toggle-btn');
            const title = document.getElementById('timer-title');

            if (timerMode === 'elapsed') {
                timerMode = 'remaining';
                btn.innerText = "Ver Idade Atual";
                title.innerText = "Tempo Restante Estimado";
                title.classList.add('text-rose-400');
                title.classList.remove('text-slate-400', 'dark:text-slate-500');
            } else {
                timerMode = 'elapsed';
                btn.innerText = "Ver Tempo Restante";
                title.innerText = "Sua Idade Cronológica";
                title.classList.remove('text-rose-400');
                title.classList.add('text-slate-400', 'dark:text-slate-500');
            }

            // Restart timer with new mode if data exists
            if (currentBirthDate && currentExpectancy) {
                startLiveTimer(currentBirthDate, currentExpectancy);
            }
        }

        // Helper: Parse date as local midnight (avoids UTC offset issues)
        function parseLocalMidnight(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            const savedDate = localStorage.getItem('birthdate');
            const savedExpectancy = localStorage.getItem('lifeExpectancy');
            
            if (savedDate && savedExpectancy) {
                renderApp(parseLocalMidnight(savedDate), parseInt(savedExpectancy));
            } else {
                document.getElementById('setup-panel').classList.remove('hidden');
            }
        });

        // --- MODAL FUNCTIONS ---
        function resetData() {
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('reset-modal').classList.add('hidden');
        }

        function confirmResetAction() {
            // Limpar dados
            localStorage.removeItem('birthdate');
            localStorage.removeItem('lifeExpectancy');
            
            // Parar timer
            if (timerInterval) clearInterval(timerInterval);
            
            // Fechar modal
            closeModal();

            // Resetar UI manualmente
            document.getElementById('setup-panel').classList.remove('hidden');
            
            // Esconder painéis do app
            document.getElementById('live-timer-panel').classList.add('hidden');
            document.getElementById('stats-panel').classList.add('hidden');
            document.getElementById('life-grid-container').classList.add('hidden');
            document.getElementById('quote-panel').classList.add('hidden');
            
            // Limpar input e grid
            document.getElementById('birthdate-input').value = '';
            document.getElementById('expectancy-input').value = '80'; // Reset para padrão
            document.getElementById('life-grid').innerHTML = '';
        }

        function generateChart() {
            const dateInput = document.getElementById('birthdate-input').value;
            const expectancyInput = document.getElementById('expectancy-input').value;

            if (!dateInput) {
                alert("Por favor, selecione uma data de nascimento.");
                return;
            }

            if (!expectancyInput || expectancyInput < 1) {
                alert("Por favor, insira uma expectativa de vida válida.");
                return;
            }

            // Parse as local midnight
            const birthDate = parseLocalMidnight(dateInput);
            const today = new Date();
            
            if (birthDate > today) {
                alert("A data deve ser no passado.");
                return;
            }

            localStorage.setItem('birthdate', dateInput);
            localStorage.setItem('lifeExpectancy', expectancyInput);
            
            // Hide setup, show animation
            document.getElementById('setup-panel').classList.add('hidden');
            renderApp(birthDate, parseInt(expectancyInput));
        }

        function renderApp(birthDate, expectedYears) {
            currentBirthDate = birthDate;
            currentExpectancy = expectedYears;

            const today = new Date();
            const totalWeeks = expectedYears * WEEKS_PER_YEAR;
            
            // Calculate weeks lived
            const timeDiff = today.getTime() - birthDate.getTime();
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
            const weeksLived = Math.floor(daysDiff / 7);
            
            // Calculate months lived
            let monthsLived = (today.getFullYear() - birthDate.getFullYear()) * 12;
            monthsLived -= birthDate.getMonth();
            monthsLived += today.getMonth();
            if (today.getDate() < birthDate.getDate()) {
                monthsLived--;
            }
            
            const weeksLeft = Math.max(0, totalWeeks - weeksLived);
            const percentage = Math.min(100, ((weeksLived / totalWeeks) * 100)).toFixed(1);

            // Update Stats Labels
            document.getElementById('life-total-label').innerText = `Vida (${expectedYears} Anos)`;
            
            // Update Stats Values
            document.getElementById('weeks-lived').innerText = weeksLived.toLocaleString();
            document.getElementById('months-lived').innerText = monthsLived.toLocaleString();
            document.getElementById('percentage-lived').innerText = percentage + "%";
            document.getElementById('weeks-left').innerText = weeksLeft.toLocaleString();

            // Show Panels
            document.getElementById('stats-panel').classList.remove('hidden');
            document.getElementById('live-timer-panel').classList.remove('hidden');
            document.getElementById('quote-panel').classList.remove('hidden');
            document.getElementById('life-grid-container').classList.remove('hidden');
            
            renderGrid(weeksLived, totalWeeks);
            startLiveTimer(birthDate, expectedYears);
        }

        // --- LIVE TIMER LOGIC ---
        function startLiveTimer(birthDate, expectedYears) {
            const yearsEl = document.getElementById('timer-years');
            const daysEl = document.getElementById('timer-days');
            const hoursEl = document.getElementById('timer-hours');
            const minsEl = document.getElementById('timer-minutes');
            const secsEl = document.getElementById('timer-seconds');

            const deathDate = new Date(birthDate);
            deathDate.setFullYear(birthDate.getFullYear() + expectedYears);

            const updateTimer = () => {
                const now = new Date();
                let diff;

                if (timerMode === 'elapsed') {
                    // Time since birth (Age)
                    diff = now - birthDate;
                } else {
                    // Time until death (Remaining)
                    diff = deathDate - now;
                    if (diff < 0) diff = 0;
                }

                // Calculations
                const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
                const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                // Update DOM (formatting with leading zeros for time)
                yearsEl.innerText = years;
                daysEl.innerText = days;
                hoursEl.innerText = hours.toString().padStart(2, '0');
                minsEl.innerText = minutes.toString().padStart(2, '0');
                secsEl.innerText = seconds.toString().padStart(2, '0');
            };

            updateTimer(); // Run immediately
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        function renderGrid(weeksLived, totalWeeks) {
            const grid = document.getElementById('life-grid');
            grid.innerHTML = '';
            
            const fragment = document.createDocumentFragment();

            for (let i = 0; i < totalWeeks; i++) {
                const box = document.createElement('div');
                
                // Determine state
                const isLived = i < weeksLived;
                const isCurrent = i === weeksLived;
                const isBirthday = (i % 52 === 0);
                
                // Base classes
                let classes = "week-box w-2 h-2 sm:w-2.5 sm:h-2.5 ";
                
                if (isCurrent) {
                    classes += "bg-amber-400 current-week shadow-[0_0_10px_rgba(251,191,36,0.8)] scale-110 z-10 rounded-sm";
                } else if (isBirthday) {
                    if (isLived) {
                         classes += "bg-gradient-to-br from-pink-500 to-rose-600 shadow-[0_0_2px_rgba(244,63,94,0.5)] z-0";
                    } else {
                         classes += "bg-rose-200 dark:bg-rose-900/40 hover:bg-rose-300 dark:hover:bg-rose-800";
                    }
                } else if (isLived) {
                    classes += "bg-gradient-to-br from-indigo-500 to-purple-600 dark:from-indigo-600 dark:to-purple-700 shadow-[0_0_2px_rgba(99,102,241,0.3)]";
                } else {
                    classes += "bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700";
                }

                box.className = classes;
                
                // Tooltip
                const yearNum = Math.floor(i / 52);
                const weekNum = (i % 52) + 1;
                
                if (isCurrent) {
                    box.title = `VOCÊ ESTÁ AQUI! Ano ${yearNum}, Semana ${weekNum}`;
                } else if (isBirthday) {
                     box.title = `Aniversário de ${yearNum} anos!`;
                } else {
                    box.title = `${yearNum} anos, semana ${weekNum}`;
                }

                fragment.appendChild(box);
            }

            grid.appendChild(fragment);
        }
    </script>
</body>
</html>
